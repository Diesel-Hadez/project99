<!DOCTYPE HTML5> 
<html>
	<head>
		<title>Project 66</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="node_modules/trumbowyg/dist/trumbowyg.min.js"></script>
		<link rel="stylesheet" href="node_modules/trumbowyg/dist/ui/trumbowyg.min.css">
	<script>
		window.onload = function(){
			var userpass = prompt("Enter password: ");
			var oldText = '';
			window.setInterval(function () {
				//If the text in the box has been updated
				//Note this only applies to teachers, checked
				//server-side
				if ($('#test').trumbowyg('html') != oldText) {
					oldText = $('#test').trumbowyg('html');
					let toSend = { message: oldText, type: "board", password: userpass };
					serverSocket.send(JSON.stringify(toSend));
				}
				//if the drawbox has been updated
				if (sendBuf != '') {
					//Get rid of trailing comma
					sendBuf = sendBuf.substring(0, sendBuf.length-1);
					let toSend = { message: sendBuf, type: "drawbox", password: userpass};
					serverSocket.send(JSON.stringify(toSend));
					sendBuf = '';
				}
			}, 200);
			var serverSocket = new WebSocket("ws://127.0.0.1:6789"); 
				serverSocket.onopen = function() {
					let toSend = { message: "Registration", type: "register", password: userpass };
					serverSocket.send(JSON.stringify(toSend));

				};
			serverSocket.onmessage = function (event) {
				console.log(event.data);
				received = JSON.parse(event.data);
				if (received.type == "question") {
					$('#qlist').append("<li>" + received.message + "</li>");
					return;
				}
				else if (received.type == "board") {
					if (received.message == oldText)
						return;
					$('#test').trumbowyg('html', received.message);
				}
				else if (received.type == "drawbox") {
					for (var line of received.message.split('\n'))
                                {
                                        let data = line.split(';');
                                        if (data.length !== 2)
                                                continue;
                                        var receivedPrevPos = {x:0,y:0};
                                        var receivedCurPos      = {x:0,y:0};
                                        if (data[0].substring(0,2) === 'DP'){
                                                receivedPrevPos.x = data[0].substring(3,data[0].indexOf(','));
                                                receivedPrevPos.y = data[0].substring(data[0].indexOf(',')+1,data[0].indexOf(')'));
                                        }
                                        if (data[1].substring(0,2) === 'DC'){
                                                receivedCurPos.x = data[1].substring(3,data[1].indexOf(','));
                                                receivedCurPos.y = data[1].substring(data[1].indexOf(',')+1,data[1].indexOf(')'));
                                        }
                                        ctx.beginPath();
                                        ctx.moveTo(receivedPrevPos.x, receivedPrevPos.y);
                                        ctx.lineTo(receivedCurPos.x, receivedCurPos.y);
                                        ctx.strokeStyle = 'black';
                                        ctx.lineWidth = 3;
                                        ctx.stroke();
                                        ctx.closePath();
                                }

					
				}
			}
			const canvas	= document.getElementById("canvasTest");
			const ctx	= canvas.getContext('2d');
			var isDraw = false;
			var inCanv = false;
			var canvBoundRect = canvas.getBoundingClientRect();
			var prevPos = {x:0, y:0};
			var curPos = {x: 0,y: 0};
			var sendBuf = "";

			function Draw() {
				sendBuf += ('DP(' + prevPos.x + ',' + prevPos.y + ');' + 'DC(' + curPos.x  +     ',' + curPos.y  + ')\n');
				ctx.beginPath();
				ctx.moveTo(prevPos.x, prevPos.y);
				ctx.lineTo(curPos.x, prevPos.y);
				ctx.strokeStyle = 'black';
				ctx.lineWidth = 3;
				ctx.stroke();
				ctx.closePath();
			}

			function GetPos(event) {
				return {x: event.clientX - canvBoundRect.left, 
				y: event.clientY - canvBoundRect.top};
			}

			canvas.addEventListener('mousemove', function(event) {
				if (isDraw) {
					curPos = GetPos(event);
					Draw();
					prevPos = curPos;
				}
			});

			canvas.addEventListener('mousedown', function(event){
				if (inCanv &&
					event.buttons === 1)
				{
					isDraw = true;
					prevPos = GetPos(event);
				}
			});

			canvas.addEventListener('mouseout', function(event) {
				if (event.buttons === 1) {
					isDraw = false;
					inCanv = false;
				}
			});

			canvas.addEventListener('mouseup', function(event) {
				isDraw = false;
			});
			canvas.addEventListener('mouseenter', function(event) {
				inCanv = true;
			});
		};
			function send_question() {
				let question = prompt("Ask a question");
				let toSend = {message: question, type: "question", password:userpass};
				serverSocket.send(JSON.stringify(toSend))
				console.log(JSON.stringify(toSend));
			}

	</script>

	<style>
		canvas {border: 1px solid black;}
	</style>
	</head>
	<body>
		<h1>Initial Demo</h1>
		<div id="test"></div>
		<a onclick="send_question()">Ask a question!</a>
		<h2>Question List</h2>
		<ul id= "qlist">
		</ul>
		<canvas id="canvasTest" width=500 height=500></canvas>
	<script>
		$('#test').trumbowyg();
	</script>
	</body>
</html>
